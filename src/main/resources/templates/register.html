<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
<meta charset="UTF-8">
<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />
<meta charset="UTF-8">
<title>会員登録</title>
<style>
body {
	font-family: Arial, sans-serif;
	background: #f5f5f5;
	padding: 20px;
}

.container {
	max-width: 500px;
	margin: 0 auto;
	background: #fff;
	padding: 20px;
	border-radius: 5px;
	box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.error {
	color: red;
	margin-top: 5px;
	font-size: 0.9em;
}

input:invalid {
	border-color: red;
}
</style>
</head>

<body>
	<div class="container">
		<h1>会員登録</h1>
		<form id="registerForm" method="post" th:action="@{/user/register}">
			<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
			
			<label>ID</label> 
			<input type="text" name="username" id="username" required>
			<div id="usernameError" class="error"></div>

			<label>ニックネーム</label>
			<input type="text" name="name" id="name" required>
			<div id="nameError" class="error"></div>

			<label>パスワード</label> 
			<input type="password" name="password" id="password" required>
			<div id="passwordError" class="error"></div>

			<button type="submit">登録</button>
		</form>
		<div class="links">
			<a th:href="@{/user/login}">ログイン</a> | <a href="/">ホーム</a>
		</div>
	</div>

	<script>
        document.getElementById('username').addEventListener('blur', function() {
            const username = this.value.trim();
            const errorDiv = document.getElementById('usernameError');
            if (username.length < 4 || username.length > 20 || !/^[a-zA-Z0-9]+$/.test(username)) {
                errorDiv.innerText = "IDは英語+数字4~20文字である必要があります。";
                return;
            }
            fetch(`/user/check-username?username=${username}`)
                .then(res => res.json())
                .then(data => {
                    errorDiv.innerText = data.exists ? "既に使用中のIDです。" : "";
                });
        });

        document.getElementById('name').addEventListener('blur', function() {
            const name = this.value.trim();
            const errorDiv = document.getElementById('nameError');
            if (name.length < 2 || name.length > 20 || !/^[\u3040-\u30FF\u4E00-\u9FFFa-zA-Z0-9]+$/.test(name)) {
                errorDiv.innerText = "ニックネームはハングル/英文/数字の2~20文字である必要があります。";
                return;
            }
            fetch(`/user/check-name?name=${name}`)
                .then(res => res.json())
                .then(data => {
                    errorDiv.innerText = data.exists ? "既に使用中のニックネームです。" : "";
                });
        });

        document.getElementById('registerForm').addEventListener('submit', function(e) {
            const usernameError = document.getElementById('usernameError').innerText;
            const nameError = document.getElementById('nameError').innerText;
            const password = document.getElementById('password').value.trim();
            const passwordErrorDiv = document.getElementById('passwordError');

            if (password.length < 6 || password.length > 20 || !/^[a-zA-Z0-9!@#$%^&*]+$/.test(password)) {
                passwordErrorDiv.innerText = "パスワードは6~20文字、特殊文字を含むことができます。";
                e.preventDefault();
                return;
            } else {
                passwordErrorDiv.innerText = "";
            }

            if (usernameError || nameError) {
                e.preventDefault();
            }
        });
    </script>
</body>

</html>